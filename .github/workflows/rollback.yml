name: BE Rollback

on:
  workflow_dispatch:
    inputs:
      release_id:
        description: "ë¡¤ë°±í•˜ë ¤ëŠ” ë²„ì „ (ë¯¸ì…ë ¥ ì‹œ backupìœ¼ë¡œ ìë™ ë¡¤ë°±)"
        required: false
        default: ""

jobs:
  guard:
    name: Guard
    runs-on: ubuntu-latest
    steps:
      - run: |
          if [[ "${GITHUB_REF_NAME}" != "main" && "${GITHUB_REF_NAME}" != "dev" ]]; then
            echo "âŒ main í˜¹ì€ dev ë¸Œëœì¹˜ì— ëŒ€í•´ì„œë§Œ ë¡¤ë°± ì›Œí¬í”Œë¡œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
            exit 1
          fi

  prepare:
    name: Prepare
    runs-on: ubuntu-latest
    needs: guard
    environment: ${{ github.ref_name == 'main' && 'prod' || 'dev' }}
    env:
      ENV_NAME: ${{ github.ref_name == 'main' && 'prod' || 'dev' }}
    timeout-minutes: 5

    steps:
      - name: Print inputs
        run: |
          echo "environment=$ENV_NAME"
          echo "release_id=${{ inputs.release_id || 'backup' }}"

      # 1) release_id ìˆìœ¼ë©´ íŠ¹ì • ë²„ì „ìœ¼ë¡œ ë¡¤ë°±
      - name: Prepare rollback to target release
        if: ${{ inputs.release_id != '' }}
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ github.ref_name == 'main' && secrets.AWS_HOST || secrets.AWS_DEV_HOST }}
          username: ${{ secrets.AWS_USERNAME }}
          key: ${{ github.ref_name == 'main' && secrets.AWS_SSH_KEY || secrets.AWS_DEV_SSH_KEY }}
          script: |
            set -euo pipefail

            ENV_NAME='${{ env.ENV_NAME }}'
            echo "ğŸŒ $ENV_NAME ì„œë²„ì—ì„œ ${{ inputs.release_id }}ë¡œ ë¡¤ë°±ì„ ì§„í–‰í•©ë‹ˆë‹¤."

            # === ì„¤ì • ë³€ìˆ˜ ===
            BASE_DIR="/opt/app/backend"
            RELEASES_DIR="${BASE_DIR}/releases"
            RELEASE_DIR="${RELEASES_DIR}/${{ inputs.release_id }}"
            CURRENT_LINK="${BASE_DIR}/current"
            BACKUP_LINK="${BASE_DIR}/backup"

            # 1) release_id ì¡´ì¬ ìœ ë¬´ í™•ì¸ (ì—†ìœ¼ë©´ ì¢…ë£Œ)
            if [ ! -d "${RELEASE_DIR}" ]; then
              echo "âŒ ì§€ì •í•œ release_id ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤: ${RELEASE_DIR}"
              echo "ğŸ“Œ releases ëª©ë¡:"
              ls -Alt "${RELEASES_DIR}" || true
              exit 1
            fi

            # 2) CURRENT_LINKì´ ê°€ë¦¬í‚¤ëŠ” ì‹¤ì œ ê²½ë¡œë¥¼ BACKUP_LINKë¡œ, RELEASE_DIRì„ CURRENT_LINKë¡œ êµì²´
            CURRENT_RELEASE="$(readlink -f "${CURRENT_LINK}")"
            TARGET_RELEASE="$(readlink -f "${RELEASE_DIR}")"

            if [ "${CURRENT_RELEASE}" = "${TARGET_RELEASE}" ]; then
              echo "â„¹ï¸ ë°±ì—…í•˜ë ¤ëŠ” ë²„ì „ê³¼ í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ë²„ì „ì´ ë™ì¼í•©ë‹ˆë‹¤."
              exit 0
            fi

            ln -sfn "${CURRENT_RELEASE}" "${BACKUP_LINK}"
            ln -sfn "${TARGET_RELEASE}" "${CURRENT_LINK}"

      # 2) release_id ì—†ìœ¼ë©´ backup ë§í¬ë¡œ ë¡¤ë°±
      - name: Prepare rollback to backup link
        if: ${{ inputs.release_id == '' }}
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ github.ref_name == 'main' && secrets.AWS_HOST || secrets.AWS_DEV_HOST }}
          username: ${{ secrets.AWS_USERNAME }}
          key: ${{ github.ref_name == 'main' && secrets.AWS_SSH_KEY || secrets.AWS_DEV_SSH_KEY }}
          script: |
            set -euo pipefail

            ENV_NAME='${{ env.ENV_NAME }}'
            echo "ğŸŒ $ENV_NAME ì„œë²„ì—ì„œ Backupìœ¼ë¡œ ë¡¤ë°±ì„ ì§„í–‰í•©ë‹ˆë‹¤."

            # === ì„¤ì • ë³€ìˆ˜ ===
            BASE_DIR="/opt/app/backend"
            CURRENT_LINK="${BASE_DIR}/current"
            BACKUP_LINK="${BASE_DIR}/backup"

            # 1) backup, current ì‹¬ë³¼ë¦­ ë§í¬ ìŠ¤ì™€í•‘
            BACKUP_RELEASE="$(readlink -f "${BACKUP_LINK}")"
            CURRENT_RELEASE="$(readlink -f "${CURRENT_LINK}")"
            ln -sfn "${BACKUP_RELEASE}" "${CURRENT_LINK}"
            ln -sfn "${CURRENT_RELEASE}" "${BACKUP_LINK}"

  perform:
    name: Perform
    runs-on: ubuntu-latest
    needs: [guard, prepare]
    environment: ${{ github.ref_name == 'main' && 'prod' || 'dev' }}
    timeout-minutes: 15

    steps:
      - name: Perform Rollback
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ github.ref_name == 'main' && secrets.AWS_HOST || secrets.AWS_DEV_HOST }}
          username: ${{ secrets.AWS_USERNAME }}
          key: ${{ github.ref_name == 'main' && secrets.AWS_SSH_KEY || secrets.AWS_DEV_SSH_KEY }}
          script: |
            set -euo pipefail

            # === ì„¤ì • ë³€ìˆ˜ ===
            BASE_DIR="/opt/app/backend"
            RELEASES_DIR="${BASE_DIR}/releases"
            CURRENT_LINK="${BASE_DIR}/current"
            BACKUP_LINK="${BASE_DIR}/backup"
            UPSTREAM_CONF="/etc/caddy/conf.d/upstream.caddy"
            BLUE_PORT=8080
            GREEN_PORT=8081

            # 1) í¬íŠ¸ í™•ì¸ ë° ê²°ì •
            CURRENT_PORT="$(grep -Eo 'localhost:(8080|8081)' "${UPSTREAM_CONF}" | awk -F: '{print $2}' | head -n1 || true)"

            if [ -z "$CURRENT_PORT" ]; then
              echo "âŒ upstreamì—ì„œ í˜„ì¬ í™œì„± í¬íŠ¸ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
              echo "ğŸš¨ ì•ˆì „ì„ ìœ„í•´ ë¡¤ë°±ì„ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
              exit 1
            fi

            if [ "$CURRENT_PORT" = "$BLUE_PORT" ]; then
              TARGET_PORT="$GREEN_PORT"
            else
              TARGET_PORT="$BLUE_PORT"
            fi

            TARGET_NAME="daeng-backend-${TARGET_PORT}"
            CURRENT_NAME="daeng-backend-${CURRENT_PORT}"

            echo "ğŸ”µ í˜„ì¬ í™œì„± í¬íŠ¸: $CURRENT_PORT"
            echo "ğŸŸ¢ ë°°í¬ íƒ€ê²Ÿ í¬íŠ¸: $TARGET_PORT"

            # 2) íƒ€ê²Ÿ í¬íŠ¸ì˜ ì¢€ë¹„ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
            PID_TO_KILL=$(lsof -ti :${TARGET_PORT} || true)
            if [ -n "$PID_TO_KILL" ]; then
              echo "ğŸ§¹ íƒ€ê²Ÿ í¬íŠ¸($TARGET_PORT)ì˜ ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬..."
              kill -9 $PID_TO_KILL || true
            fi

            # 3) ìƒˆ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ (PM2)
            echo "ğŸš€ PM2ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ (Port: $TARGET_PORT)..."

            pm2 delete "${TARGET_NAME}" 2>/dev/null || true

            TARGET_PORT=${TARGET_PORT} JAR_PATH=${CURRENT_LINK}/app.jar pm2 start ${BASE_DIR}/ecosystem.config.js
            pm2 save

            # 4) í—¬ìŠ¤ì²´í¬
            echo "ğŸ¥ í—¬ìŠ¤ ì²´í¬ ì‹œì‘..."

            HEALTH_CHECK_URL="http://localhost:${TARGET_PORT}/api/v3/health"
            IS_HEALTHY=0

            for i in {1..10}; do
              sleep 5
              HTTP_CODE="$(curl -s -o /dev/null -w "%{http_code}" --max-time 2 "${HEALTH_CHECK_URL}" || true)"
              if [ "${HTTP_CODE}" == "200" ]; then
                echo "âœ… í—¬ìŠ¤ ì²´í¬ ì„±ê³µ!"
                IS_HEALTHY=1
                break
              else
                echo "â³ ì‹œì‘ ëŒ€ê¸° ì¤‘.... ($i/10) (Code: ${HTTP_CODE})"
              fi
            done

            # í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ ì‹œ ë°°í¬ ì¤‘ë‹¨
            if [ "$IS_HEALTHY" -ne 1 ]; then
              echo "âŒ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨. ë¡¤ë°±ì„ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
              pm2 delete "${TARGET_NAME}" || true
              exit 1
            fi

            # 5) íŠ¸ë˜í”½ ì „í™˜ (í¬íŠ¸ ìŠ¤ìœ„ì¹­)
            echo "ğŸ”„ Caddy ì—°ê²° ë³€ê²½ ì¤‘ (Port: ${CURRENT_PORT} â†’ ${TARGET_PORT})..."

            echo "reverse_proxy localhost:${TARGET_PORT}" | tee ${UPSTREAM_CONF} > /dev/null

            if caddy reload --config /etc/caddy/Caddyfile; then
              echo "ğŸ‰ ë¡¤ë°± ì„±ê³µ ë° íŠ¸ë˜í”½ ì „í™˜ ì™„ë£Œ."

              # 6) êµ¬ë²„ì „ ì¢…ë£Œ
              echo "ğŸ›‘ êµ¬ë²„ì „ í”„ë¡œì„¸ìŠ¤ ì‚­ì œ (Port: $CURRENT_PORT)..."
              pm2 delete "${CURRENT_NAME}" || true
              pm2 save
            else
              echo "ğŸš¨ Caddy Reload ì‹¤íŒ¨! ë¡¤ë°±ì„ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
              pm2 delete "${TARGET_NAME}" || true
              exit 1
            fi

  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [guard, prepare, perform]
    if: always()

    steps:
      - name: Notify Discord (Rollback Success)
        if: needs.guard.result == 'success' && needs.prepare.result == 'success' && needs.perform.result == 'success'
        uses: Ilshidur/action-discord@0.4.0
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          DISCORD_EMBEDS: |
            [{
              "title": "[BE] Rollback: success",
              "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "color": 5763719,
              "description": "${{ github.ref_name == 'main' && 'prod' || 'dev' }} í™˜ê²½ ë¡¤ë°± ì™„ë£Œ",
              "fields": [
                {"name": "Release ID", "value": "`${{ inputs.release_id || 'backup' }}`", "inline": true},
                {"name": "Actor", "value": "${{ github.actor }}", "inline": true},
                {"name": "Branch", "value": "${{ github.ref_name }}", "inline": true},
                {"name": "Prepare", "value": "`${{ needs.prepare.result }}`", "inline": true},
                {"name": "Perform", "value": "`${{ needs.perform.result }}`", "inline": true}
              ]
            }]

      - name: Notify Discord (Rollback Failure)
        if: always() && (needs.guard.result != 'success' || needs.prepare.result != 'success' || needs.perform.result != 'success')
        uses: Ilshidur/action-discord@0.4.0
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          DISCORD_EMBEDS: |
            [{
              "title": "[BE] Rollback: failure",
              "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "color": 15548997,
              "description": "${{ github.ref_name == 'main' && 'prod' || 'dev' }} í™˜ê²½ ë¡¤ë°± ì‹¤íŒ¨",
              "fields": [
                {"name": "Release ID", "value": "`${{ inputs.release_id || 'backup' }}`", "inline": true},
                {"name": "Actor", "value": "${{ github.actor }}", "inline": true},
                {"name": "Branch", "value": "${{ github.ref_name }}", "inline": true},
                {"name": "Guard", "value": "`${{ needs.guard.result }}`", "inline": true},
                {"name": "Prepare", "value": "`${{ needs.prepare.result }}`", "inline": true},
                {"name": "Perform", "value": "`${{ needs.perform.result }}`", "inline": true}
              ]
            }]