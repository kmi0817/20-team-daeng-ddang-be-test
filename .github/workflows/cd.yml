name: BE CD

on:
  workflow_run:
    workflows: ["BE CI"]
    types: [completed]

permissions:
  contents: read
  actions: read

concurrency:
  group: be-cd-dev-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: true

env:
  RELEASE_ID: ${{ github.event.workflow_run.head_sha }}
  BRANCH: ${{ github.event.workflow_run.head_branch }}

jobs:
  cd:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Mark CD start
        id: cd_time
        run: echo "start=$(date +%s)" >> "$GITHUB_OUTPUT"

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: daeng-map-api-${{ github.event.workflow_run.id }}
          path: build/libs
          run-id: ${{ github.event.workflow_run.id }}
          repository: ${{ github.repository }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify downloaded artifact
        run: |
          echo "=== ë‹¤ìš´ë¡œë“œëœ íŒŒì¼ í™•ì¸ ==="
          ls -la build/libs/ || echo "build/libs ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤"
          find . -name "*.jar" -type f 2>/dev/null || echo "JAR íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"

      - name: Copy JAR to EC2
        id: scp
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.BRANCH == 'dev' && secrets.AWS_DEV_HOST || secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USERNAME }}
          key: ${{ env.BRANCH == 'dev' && secrets.AWS_DEV_SSH_KEY || secrets.AWS_SSH_KEY }}
          source: "build/libs/*.jar"
          target: "/tmp/be-deploy-${{ env.RELEASE_ID }}"
          strip_components: 2

      - name: Deploy with Port Switching
        id: deploy
        uses: appleboy/ssh-action@v1.0.3
        env:
          GITHUB_SHA: ${{ env.RELEASE_ID }}
          ENV_NAME: ${{ env.BRANCH == 'dev' && 'DEV' || 'PROD' }}
        with:
          host: ${{ env.BRANCH == 'dev' && secrets.AWS_DEV_HOST || secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USERNAME }}
          key: ${{ env.BRANCH == 'dev' && secrets.AWS_DEV_SSH_KEY || secrets.AWS_SSH_KEY }}
          envs: GITHUB_SHA,ENV_NAME
          script: |
            #!/usr/bin/env bash
            set -euo pipefail

            echo "ðŸŒ ${ENV_NAME} ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤."

            # === ì„¤ì • ë³€ìˆ˜ ===
            BASE_DIR="/opt/app/backend"
            RELEASES_DIR="${BASE_DIR}/releases"
            NEW_RELEASE_DIR="${RELEASES_DIR}/${GITHUB_SHA}"
            TEMP_JAR_DIR="/tmp/be-deploy-${GITHUB_SHA}"
            UPSTREAM_CONF="/etc/caddy/conf.d/upstream.caddy"
            CURRENT_LINK="${BASE_DIR}/current"
            BACKUP_LINK="${BASE_DIR}/backup"

            echo "ðŸš€ ë°°í¬ ì‹œìž‘: ${GITHUB_SHA}"

            # í´ë” ìƒì„±
            mkdir -p ${RELEASES_DIR}
            mkdir -p /etc/caddy/conf.d

            # 1. í¬íŠ¸ í™•ì¸ ë° ê²°ì • (Blue/Green)
            IS_8080_ALIVE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 2 http://localhost:8080/api/v3/health || echo "fail")

            if [ "$IS_8080_ALIVE" == "200" ]; then
              TARGET_PORT=8081
              CURRENT_PORT=8080
            else
              TARGET_PORT=8080
              CURRENT_PORT=8081
            fi

            echo "ðŸ”µ í˜„ìž¬ í™œì„± í¬íŠ¸: $CURRENT_PORT"
            echo "ðŸŸ¢ ë°°í¬ íƒ€ê²Ÿ í¬íŠ¸: $TARGET_PORT"

            # 2. íŒŒì¼ ì¤€ë¹„
            mkdir -p ${NEW_RELEASE_DIR}
            if [ -d "${TEMP_JAR_DIR}" ]; then
              mv ${TEMP_JAR_DIR}/*.jar ${NEW_RELEASE_DIR}/app.jar
            else
              echo "âŒ ì „ì†¡ëœ JAR íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
              exit 1
            fi

            # 3. ì§ì „ ë²„ì „ backup link ì €ìž¥
            if [ -L "${CURRENT_LINK}" ] || [ -d "${CURRENT_LINK}" ]; then
              CURRENT_RELEASE="$(readlink -f "${CURRENT_LINK}" || true)"
              if [ -n "${CURRENT_RELEASE}" ] && [ -d "${CURRENT_RELEASE}" ]; then
                echo "ðŸ“¦ ë°±ì—… ë§í¬ ìƒì„±: ${CURRENT_RELEASE}"
                ln -sfn "${CURRENT_RELEASE}" "${BACKUP_LINK}"
              fi
            fi

            # 4. current ë§í¬ë¥¼ ìƒˆ ë¦´ë¦¬ì¦ˆë¡œ êµì²´
            ln -sfn "${NEW_RELEASE_DIR}" "${CURRENT_LINK}"
            echo "ðŸ”— current ë§í¬ ì—…ë°ì´íŠ¸: ${NEW_RELEASE_DIR}"

            # 5. íƒ€ê²Ÿ í¬íŠ¸ì˜ ê¸°ì¡´ ì¢€ë¹„ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
            PID_TO_KILL=$(lsof -ti :${TARGET_PORT} || true)
            if [ -n "$PID_TO_KILL" ]; then
              echo "ðŸ§¹ íƒ€ê²Ÿ í¬íŠ¸($TARGET_PORT)ì˜ ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬..."
              kill -9 $PID_TO_KILL || true
            fi

            # 6. ìƒˆ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ (PM2)
            echo "ðŸš€ PM2ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œìž‘ (Port: $TARGET_PORT)..."

            pm2 delete "daeng-backend-${TARGET_PORT}" 2>/dev/null || true

            TARGET_PORT=${TARGET_PORT} JAR_PATH=${CURRENT_LINK}/app.jar pm2 start ${BASE_DIR}/ecosystem.config.js

            # 7. í—¬ìŠ¤ ì²´í¬
            echo "ðŸ¥ í—¬ìŠ¤ ì²´í¬ ì‹œìž‘..."
            HEALTH_CHECK_URL="http://localhost:${TARGET_PORT}/api/v3/health"
            IS_HEALTHY=0

            for i in {1..10}; do
              sleep 5
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" ${HEALTH_CHECK_URL} || echo "fail")

              if [ "$HTTP_CODE" == "200" ]; then
                echo "âœ… í—¬ìŠ¤ ì²´í¬ ì„±ê³µ!"
                IS_HEALTHY=1
                break
              else
                echo "â³ ì‹œìž‘ ëŒ€ê¸° ì¤‘.... ($i/10) (Code: $HTTP_CODE)"
              fi
            done

            # 8. ê²°ê³¼ ì²˜ë¦¬ ë° íŠ¸ëž˜í”½ ì „í™˜
            if [ "$IS_HEALTHY" -eq 1 ]; then
              echo "ðŸ”„ Caddy ì—°ê²° ë³€ê²½ ì¤‘ (Port: $TARGET_PORT)..."
              echo "reverse_proxy localhost:${TARGET_PORT}" | tee ${UPSTREAM_CONF} > /dev/null

              if caddy reload --config /etc/caddy/Caddyfile; then
                echo "ðŸŽ‰ ë°°í¬ ì„±ê³µ ë° íŠ¸ëž˜í”½ ì „í™˜ ì™„ë£Œ."

                # 9. êµ¬ë²„ì „ ì¢…ë£Œ
                echo "ðŸ›‘ êµ¬ë²„ì „ í”„ë¡œì„¸ìŠ¤ ì‚­ì œ (Port: $CURRENT_PORT)..."
                pm2 delete "daeng-backend-${CURRENT_PORT}" || true
                pm2 save
              else
                echo "ðŸš¨ Caddy Reload ì‹¤íŒ¨! ë¡¤ë°±í•©ë‹ˆë‹¤."
                # backup ë§í¬ë¡œ current ë³µì›
                if [ -L "${BACKUP_LINK}" ]; then
                  ln -sfn "$(readlink -f ${BACKUP_LINK})" "${CURRENT_LINK}"
                  echo "ðŸ”™ current ë§í¬ ë¡¤ë°± ì™„ë£Œ"
                fi
                pm2 delete "daeng-backend-${TARGET_PORT}" || true
                exit 1
              fi
            else
              echo "âŒ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨. ë°°í¬ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
              # backup ë§í¬ë¡œ current ë³µì›
              if [ -L "${BACKUP_LINK}" ]; then
                ln -sfn "$(readlink -f ${BACKUP_LINK})" "${CURRENT_LINK}"
                echo "ðŸ”™ current ë§í¬ ë¡¤ë°± ì™„ë£Œ"
              fi
              pm2 delete "daeng-backend-${TARGET_PORT}" || true
              exit 1
            fi

            # 10. ì˜¤ëž˜ëœ ë¦´ë¦¬ì¦ˆ í´ë” ì •ë¦¬
            echo "ðŸ§¹ ì˜¤ëž˜ëœ ë¦´ë¦¬ì¦ˆ ì •ë¦¬ ì¤‘..."
            cd ${RELEASES_DIR} && ls -t | tail -n +6 | xargs -I {} rm -rf {} || true

      - name: Mark CD end
        id: cd_time_end
        if: always()
        run: echo "end=$(date +%s)" >> "$GITHUB_OUTPUT"

      - name: Calculate CD times
        id: cd_calc
        if: always()
        env:
          COMMIT_MSG: ${{ github.event.workflow_run.head_commit.message || github.workflow }}
        run: |
          cd_total=$(( ${{ steps.cd_time_end.outputs.end }} - ${{ steps.cd_time.outputs.start }} ))
          echo "cd_total=${cd_total}" >> "$GITHUB_OUTPUT"
          # ì»¤ë°‹ ë©”ì‹œì§€ì—ì„œ ì¤„ë°”ê¿ˆì„ ê³µë°±ìœ¼ë¡œ ë³€í™˜í•˜ê³ , ìŒë”°ì˜´í‘œ ì´ìŠ¤ì¼€ì´í”„
          safe_msg=$(echo "$COMMIT_MSG" | tr '\n' ' ' | sed 's/"/\\"/g' | head -c 200)
          echo "safe_msg=${safe_msg}" >> "$GITHUB_OUTPUT"

      - name: Notify Discord (CD Success)
        if: success()
        uses: Ilshidur/action-discord@0.4.0
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          DISCORD_EMBEDS: |
            [{
              "title": "[BE] CD: success",
              "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "color": 5763719,
              "description": "${{ steps.cd_calc.outputs.safe_msg }}",
              "fields": [
                {"name": "Release ID", "value": "`${{ env.RELEASE_ID }}`", "inline": true},
                {"name": "Actor", "value": "${{ github.actor }}", "inline": true},
                {"name": "Branch", "value": "${{ github.ref_name }}", "inline": true},
                {"name": "Total CD", "value": "${{ steps.cd_calc.outputs.cd_total }}s", "inline": true},
                {"name": "Upload (SCP)", "value": "${{ steps.scp.outcome }}", "inline": true},
                {"name": "Deploy (SSH)", "value": "${{ steps.deploy.outcome }}", "inline": true}
              ],
              "timestamp": "${{ github.event.workflow_run.updated_at }}"
            }]

      - name: Notify Discord (CD Failure)
        if: failure()
        uses: Ilshidur/action-discord@0.4.0
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          DISCORD_EMBEDS: |
            [{
              "title": "[BE] CD: failure",
              "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "color": 15548997,
              "description": "${{ steps.cd_calc.outputs.safe_msg }}",
              "fields": [
                {"name": "Release ID", "value": "`${{ env.RELEASE_ID }}`", "inline": true},
                {"name": "Actor", "value": "${{ github.actor }}", "inline": true},
                {"name": "Branch", "value": "${{ github.ref_name }}", "inline": true},
                {"name": "Total CD", "value": "${{ steps.cd_calc.outputs.cd_total }}s", "inline": true},
                {"name": "Upload (SCP)", "value": "${{ steps.scp.outcome }}", "inline": true},
                {"name": "Deploy (SSH)", "value": "${{ steps.deploy.outcome }}", "inline": true}
              ],
              "timestamp": "${{ github.event.workflow_run.updated_at }}"
            }]