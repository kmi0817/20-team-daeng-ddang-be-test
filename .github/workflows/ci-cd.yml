name: BE CI/CD

on:
  pull_request:
    branches: [ "main", "dev" ]
  push:
    branches: [ "main", "dev"]
  workflow_dispatch: { }

permissions:
  contents: read

concurrency:
  group: be-ci-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  RELEASE_ID: ${{ github.sha }}

jobs:
  ci:
    name: CI
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Record CI start
        id: ci_time
        run: echo "start=$(date +%s)" >> "$GITHUB_OUTPUT"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"
          cache: "gradle"

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Test & Check
        id: time_check
        run: |
          start=$(date +%s)
          ./gradlew clean check -x test --no-daemon
          end=$(date +%s)
          echo "start=${start}" >> "$GITHUB_OUTPUT"
          echo "end=${end}" >> "$GITHUB_OUTPUT"

      - name: Build (bootJar)
        id: time_build
        run: |
          start=$(date +%s)
          ./gradlew bootJar -x test --no-daemon
          end=$(date +%s)
          echo "start=${start}" >> "$GITHUB_OUTPUT"
          echo "end=${end}" >> "$GITHUB_OUTPUT"

      - name: List artifacts
        run: ls -al build/libs

      - name: Upload build artifact (jar)
        uses: actions/upload-artifact@v4
        with:
          name: daeng-map-api-${{ env.RELEASE_ID }}
          path: build/libs/*.jar
          if-no-files-found: error
          retention-days: 30

      - name: Record CI end
        id: ci_time_end
        if: always()
        run: echo "end=$(date +%s)" >> "$GITHUB_OUTPUT"

      - name: Calculate CI times
        id: ci_calc
        if: always()
        env:
          COMMIT_MSG: ${{ github.event.pull_request.title || github.event.head_commit.message || github.workflow }}
        run: |
          ci_total=$(( ${{ steps.ci_time_end.outputs.end }} - ${{ steps.ci_time.outputs.start }} ))
          check_sec=$(( ${{ steps.time_check.outputs.end || 0 }} - ${{ steps.time_check.outputs.start || 0 }} ))
          build_sec=$(( ${{ steps.time_build.outputs.end || 0 }} - ${{ steps.time_build.outputs.start || 0 }} ))
          echo "ci_total=${ci_total}" >> "$GITHUB_OUTPUT"
          echo "check_sec=${check_sec}" >> "$GITHUB_OUTPUT"
          echo "build_sec=${build_sec}" >> "$GITHUB_OUTPUT"
          # ì»¤ë°‹ ë©”ì‹œì§€ì—ì„œ ì¤„ë°”ê¿ˆì„ ê³µë°±ìœ¼ë¡œ ë³€í™˜í•˜ê³ , ìŒë”°ì˜´í‘œ ì´ìŠ¤ì¼€ì´í”„
          safe_msg=$(echo "$COMMIT_MSG" | tr '\n' ' ' | sed 's/"/\\"/g' | head -c 200)
          echo "safe_msg=${safe_msg}" >> "$GITHUB_OUTPUT"

      - name: Notify Discord (CI Success)
        if: success()
        uses: Ilshidur/action-discord@0.4.0
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          DISCORD_EMBEDS: |
            [{
              "title": "[BE] CI: success",
              "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "color": 5763719,
              "description": "${{ steps.ci_calc.outputs.safe_msg }}",
              "fields": [
                {"name": "Release ID", "value": "`${{ env.RELEASE_ID }}`", "inline": true},
                {"name": "Actor", "value": "${{ github.actor }}", "inline": true},
                {"name": "Branch", "value": "${{ github.ref_name }}", "inline": true},
                {"name": "Total CI", "value": "${{ steps.ci_calc.outputs.ci_total }}s", "inline": true},
                {"name": "Check", "value": "${{ steps.ci_calc.outputs.check_sec }}s", "inline": true},
                {"name": "Build", "value": "${{ steps.ci_calc.outputs.build_sec }}s", "inline": true}
              ],
              "timestamp": "${{ github.event.head_commit.timestamp || github.event.pull_request.updated_at }}"
            }]

      - name: Notify Discord (CI Failure)
        if: failure()
        uses: Ilshidur/action-discord@0.4.0
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          DISCORD_EMBEDS: |
            [{
              "title": "[BE] CI: failure",
              "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "color": 15548997,
              "description": "${{ steps.ci_calc.outputs.safe_msg }}",
              "fields": [
                {"name": "Release ID", "value": "`${{ env.RELEASE_ID }}`", "inline": true},
                {"name": "Actor", "value": "${{ github.actor }}", "inline": true},
                {"name": "Branch", "value": "${{ github.ref_name }}", "inline": true},
                {"name": "Total CI", "value": "${{ steps.ci_calc.outputs.ci_total }}s", "inline": true},
                {"name": "Check", "value": "${{ steps.ci_calc.outputs.check_sec }}s", "inline": true},
                {"name": "Build", "value": "${{ steps.ci_calc.outputs.build_sec }}s", "inline": true}
              ],
              "timestamp": "${{ github.event.head_commit.timestamp || github.event.pull_request.updated_at }}"
            }]

  cd:
    name: CD
    needs: ci
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.base_ref == 'dev')
    timeout-minutes: 15

    steps:
      - name: Mark CD start
        id: cd_time
        run: echo "start=$(date +%s)" >> "$GITHUB_OUTPUT"

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: daeng-map-api-${{ env.RELEASE_ID }}
          path: build/libs

      - name: Copy JAR to EC2
        id: scp
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ (github.ref_name == 'dev' || github.base_ref == 'dev') && secrets.AWS_DEV_HOST || secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USERNAME }}
          key: ${{ (github.ref_name == 'dev' || github.base_ref == 'dev') && secrets.AWS_DEV_SSH_KEY || secrets.AWS_SSH_KEY }}
          source: "build/libs/*.jar"
          target: "/tmp/be-deploy-${{ env.RELEASE_ID }}"
          strip_components: 2

      - name: Deploy with Port Switching
        id: deploy
        uses: appleboy/ssh-action@v1.0.3
        env:
          GITHUB_SHA: ${{ github.sha }}
        with:
          host: ${{ (github.ref_name == 'dev' || github.base_ref == 'dev') && secrets.AWS_DEV_HOST || secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USERNAME }}
          key: ${{ (github.ref_name == 'dev' || github.base_ref == 'dev') && secrets.AWS_DEV_SSH_KEY || secrets.AWS_SSH_KEY }}
          envs: GITHUB_SHA
          script: |
            #!/usr/bin/env bash
            set -euo pipefail

            # === ì„¤ì • ë³€ìˆ˜ ===
            BASE_DIR="/home/ubuntu/daeng-ddang-be"
            RELEASES_DIR="${BASE_DIR}/releases"
            NEW_RELEASE_DIR="${RELEASES_DIR}/${GITHUB_SHA}"
            TEMP_JAR_DIR="/tmp/be-deploy-${GITHUB_SHA}"
            UPSTREAM_CONF="/etc/caddy/conf.d/upstream.caddy"

            echo "ðŸš€ ë°°í¬ ì‹œìž‘: ${GITHUB_SHA}"

            # í´ë” ìƒì„±
            mkdir -p ${RELEASES_DIR}
            sudo mkdir -p /etc/caddy/conf.d

            # 1. í¬íŠ¸ í™•ì¸ ë° ê²°ì • (Blue/Green)
            IS_8080_ALIVE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 2 http://localhost:8080/api/v3/health || echo "fail")

            if [ "$IS_8080_ALIVE" == "200" ]; then
              TARGET_PORT=8081
              CURRENT_PORT=8080
            else
              TARGET_PORT=8080
              CURRENT_PORT=8081
            fi

            echo "ðŸ”µ í˜„ìž¬ í™œì„± í¬íŠ¸: $CURRENT_PORT"
            echo "ðŸŸ¢ ë°°í¬ íƒ€ê²Ÿ í¬íŠ¸: $TARGET_PORT"

            # 2. íŒŒì¼ ì¤€ë¹„
            mkdir -p ${NEW_RELEASE_DIR}
            if [ -d "${TEMP_JAR_DIR}" ]; then
              mv ${TEMP_JAR_DIR}/*.jar ${NEW_RELEASE_DIR}/app.jar
            else
              echo "âŒ ì „ì†¡ëœ JAR íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
              exit 1
            fi

            # íƒ€ê²Ÿ í¬íŠ¸ì˜ ê¸°ì¡´ ì¢€ë¹„ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
            PID_TO_KILL=$(lsof -ti :${TARGET_PORT} || true)
            if [ -n "$PID_TO_KILL" ]; then
              echo "ðŸ§¹ íƒ€ê²Ÿ í¬íŠ¸($TARGET_PORT)ì˜ ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬..."
              kill -9 $PID_TO_KILL || true
            fi

            # 3. ìƒˆ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ (PM2)
            echo "ðŸš€ PM2ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œìž‘ (Port: $TARGET_PORT)..."

            pm2 delete "daeng-backend-${TARGET_PORT}" 2>/dev/null || true

            TARGET_PORT=${TARGET_PORT} JAR_PATH=${NEW_RELEASE_DIR}/app.jar pm2 start ${BASE_DIR}/ecosystem.config.js

            # 4. í—¬ìŠ¤ ì²´í¬
            echo "ðŸ¥ í—¬ìŠ¤ ì²´í¬ ì‹œìž‘..."
            HEALTH_CHECK_URL="http://localhost:${TARGET_PORT}/api/v3/health"
            IS_HEALTHY=0

            for i in {1..10}; do
              sleep 5
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" ${HEALTH_CHECK_URL} || echo "fail")

              if [ "$HTTP_CODE" == "200" ]; then
                echo "âœ… í—¬ìŠ¤ ì²´í¬ ì„±ê³µ!"
                IS_HEALTHY=1
                break
              else
                echo "â³ ì‹œìž‘ ëŒ€ê¸° ì¤‘.... ($i/10) (Code: $HTTP_CODE)"
              fi
            done

            # 5. ê²°ê³¼ ì²˜ë¦¬ ë° íŠ¸ëž˜í”½ ì „í™˜
            if [ "$IS_HEALTHY" -eq 1 ]; then
              echo "ðŸ”„ Caddy ì—°ê²° ë³€ê²½ ì¤‘ (Port: $TARGET_PORT)..."
              echo "reverse_proxy localhost:${TARGET_PORT}" | sudo tee ${UPSTREAM_CONF} > /dev/null

              if sudo caddy reload --config /etc/caddy/Caddyfile; then
                echo "ðŸŽ‰ ë°°í¬ ì„±ê³µ ë° íŠ¸ëž˜í”½ ì „í™˜ ì™„ë£Œ."

                # 6. êµ¬ë²„ì „ ì¢…ë£Œ
                echo "ðŸ›‘ êµ¬ë²„ì „ í”„ë¡œì„¸ìŠ¤ ì‚­ì œ (Port: $CURRENT_PORT)..."
                pm2 delete "daeng-backend-${CURRENT_PORT}" || true
                pm2 save
              else
                echo "ðŸš¨ Caddy Reload ì‹¤íŒ¨! ë¡¤ë°±í•©ë‹ˆë‹¤."
                pm2 delete "daeng-backend-${TARGET_PORT}" || true
                exit 1
              fi
            else
              echo "âŒ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨. ë°°í¬ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
              pm2 delete "daeng-backend-${TARGET_PORT}" || true
              exit 1
            fi

            # ì˜¤ëž˜ëœ ë¦´ë¦¬ì¦ˆ í´ë” ì •ë¦¬
            echo "ðŸ§¹ ì˜¤ëž˜ëœ ë¦´ë¦¬ì¦ˆ ì •ë¦¬ ì¤‘..."
            cd ${RELEASES_DIR} && ls -t | tail -n +6 | xargs -I {} rm -rf {} || true

      - name: Mark CD end
        id: cd_time_end
        if: always()
        run: echo "end=$(date +%s)" >> "$GITHUB_OUTPUT"

      - name: Calculate CD times
        id: cd_calc
        if: always()
        env:
          COMMIT_MSG: ${{ github.event.head_commit.message || github.workflow }}
        run: |
          cd_total=$(( ${{ steps.cd_time_end.outputs.end }} - ${{ steps.cd_time.outputs.start }} ))
          echo "cd_total=${cd_total}" >> "$GITHUB_OUTPUT"
          # ì»¤ë°‹ ë©”ì‹œì§€ì—ì„œ ì¤„ë°”ê¿ˆì„ ê³µë°±ìœ¼ë¡œ ë³€í™˜í•˜ê³ , ìŒë”°ì˜´í‘œ ì´ìŠ¤ì¼€ì´í”„
          safe_msg=$(echo "$COMMIT_MSG" | tr '\n' ' ' | sed 's/"/\\"/g' | head -c 200)
          echo "safe_msg=${safe_msg}" >> "$GITHUB_OUTPUT"

      - name: Notify Discord (CD Success)
        if: success()
        uses: Ilshidur/action-discord@0.4.0
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          DISCORD_EMBEDS: |
            [{
              "title": "[BE] CD: success",
              "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "color": 5763719,
              "description": "${{ steps.cd_calc.outputs.safe_msg }}",
              "fields": [
                {"name": "Release ID", "value": "`${{ env.RELEASE_ID }}`", "inline": true},
                {"name": "Actor", "value": "${{ github.actor }}", "inline": true},
                {"name": "Branch", "value": "${{ github.ref_name }}", "inline": true},
                {"name": "Total CD", "value": "${{ steps.cd_calc.outputs.cd_total }}s", "inline": true},
                {"name": "Upload (SCP)", "value": "${{ steps.scp.outcome }}", "inline": true},
                {"name": "Deploy (SSH)", "value": "${{ steps.deploy.outcome }}", "inline": true}
              ],
              "timestamp": "${{ github.event.head_commit.timestamp }}"
            }]

      - name: Notify Discord (CD Failure)
        if: failure()
        uses: Ilshidur/action-discord@0.4.0
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          DISCORD_EMBEDS: |
            [{
              "title": "[BE] CD: failure",
              "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "color": 15548997,
              "description": "${{ steps.cd_calc.outputs.safe_msg }}",
              "fields": [
                {"name": "Release ID", "value": "`${{ env.RELEASE_ID }}`", "inline": true},
                {"name": "Actor", "value": "${{ github.actor }}", "inline": true},
                {"name": "Branch", "value": "${{ github.ref_name }}", "inline": true},
                {"name": "Total CD", "value": "${{ steps.cd_calc.outputs.cd_total }}s", "inline": true},
                {"name": "Upload (SCP)", "value": "${{ steps.scp.outcome }}", "inline": true},
                {"name": "Deploy (SSH)", "value": "${{ steps.deploy.outcome }}", "inline": true}
              ],
              "timestamp": "${{ github.event.head_commit.timestamp }}"
            }]