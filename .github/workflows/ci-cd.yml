name: BE CI

on:
  pull_request:
    branches: [ "main", "dev" ]
  push:
    branches: [ "main", "dev", "feat/ci-d" ]
  # ì½”ë“œ ë³€ê²½ì—†ì´ CI ìŠ¤í¬ë¦½íŠ¸ê°€ ì˜ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í•˜ê³  ì‹¶ì–´ì„œ ì‚¬ìš©
  workflow_dispatch: { }

permissions:
  contents: read

concurrency:
  group: be-ci-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:

  ci:
    name: CI
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"
          cache: "gradle"

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Test & Check
        run: ./gradlew clean check -x test --no-daemon

      - name: Build (bootJar)
        run: ./gradlew bootJar -x test --no-daemon

      - name: List artifacts
        run: ls -al build/libs

      - name: Upload build artifact (jar)
        uses: actions/upload-artifact@v4
        with:
          name: daeng-map-api-${{ github.sha }}
          path: build/libs/*.jar
          if-no-files-found: error
          retention-days: 30

  cd:
    name: cd
    #if : github.event_name == 'push'
    needs: ci
    runs-on: ubuntu-latest

    steps:
      # ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: daeng-map-api-${{ github.sha }}
          path: build/libs

      # 1. íŒŒì¼ ì „ì†¡ (SCP) -> ì„ì‹œ í´ë”ë¡œ ì „ì†¡
      - name: Copy JAR to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USERNAME }}
          key: ${{ secrets.AWS_SSH_KEY }}
          source: "build/libs/*.jar"
          target: "/tmp/be-deploy-${{ github.sha }}"
          strip_components: 2 # build/libs/ ê²½ë¡œ ì œê±°í•˜ê³  jarë§Œ ì „ì†¡

      # 2. ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (Blue/Green Logic)
      - name: Deploy with Port Switching
        uses: appleboy/ssh-action@v1.0.3
        env:
          GITHUB_SHA: ${{ github.sha }}
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USERNAME }}
          key: ${{ secrets.AWS_SSH_KEY }}
          envs: GITHUB_SHA
          script: |
            #!/usr/bin/env bash
            set -euo pipefail

            # === ì„¤ì • ë³€ìˆ˜ ===
            BASE_DIR="/home/ubuntu/daeng-ddang-be"
            RELEASES_DIR="${BASE_DIR}/releases"
            NEW_RELEASE_DIR="${RELEASES_DIR}/${GITHUB_SHA}"
            TEMP_JAR_DIR="/tmp/be-deploy-${GITHUB_SHA}"
            UPSTREAM_CONF="/etc/caddy/conf.d/upstream.caddy"

            echo "ğŸš€ ë°°í¬ ì‹œì‘: ${GITHUB_SHA}"

            # í´ë” ìƒì„±
            mkdir -p ${RELEASES_DIR}
            sudo mkdir -p /etc/caddy/conf.d

            # 1. í¬íŠ¸ í™•ì¸ ë° ê²°ì • (Blue/Green)
            IS_8080_ALIVE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 2 http://localhost:8080/api/v3/health || echo "fail")

            if [ "$IS_8080_ALIVE" == "200" ]; then
              TARGET_PORT=8081
              CURRENT_PORT=8080
            else
              TARGET_PORT=8080
              CURRENT_PORT=8081
            fi

            echo "ğŸ”µ í˜„ì¬ í™œì„± í¬íŠ¸: $CURRENT_PORT"
            echo "ğŸŸ¢ ë°°í¬ íƒ€ê²Ÿ í¬íŠ¸: $TARGET_PORT"

            # 2. íŒŒì¼ ì¤€ë¹„
            mkdir -p ${NEW_RELEASE_DIR}
            if [ -d "${TEMP_JAR_DIR}" ]; then
              mv ${TEMP_JAR_DIR}/*.jar ${NEW_RELEASE_DIR}/app.jar
            else
              echo "âŒ ì „ì†¡ëœ JAR íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
              exit 1
            fi

            # íƒ€ê²Ÿ í¬íŠ¸ì˜ ê¸°ì¡´ ì¢€ë¹„ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
            PID_TO_KILL=$(lsof -ti :${TARGET_PORT} || true)
            if [ -n "$PID_TO_KILL" ]; then
              echo "ğŸ§¹ íƒ€ê²Ÿ í¬íŠ¸($TARGET_PORT)ì˜ ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬..."
              kill -9 $PID_TO_KILL || true
            fi

            # 3. ìƒˆ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ (PM2)
            echo "ğŸš€ PM2ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ (Port: $TARGET_PORT)..."

            pm2 delete "daeng-backend-${TARGET_PORT}" || true

            pm2 start java --name "daeng-backend-${TARGET_PORT}" -- \
              -jar -Dserver.port=${TARGET_PORT} -Dspring.profiles.active=prod ${NEW_RELEASE_DIR}/app.jar

            # 4. í—¬ìŠ¤ ì²´í¬
            echo "ğŸ¥ í—¬ìŠ¤ ì²´í¬ ì‹œì‘..."
            HEALTH_CHECK_URL="http://localhost:${TARGET_PORT}/api/v3/health"
            IS_HEALTHY=0

            for i in {1..10}; do
              sleep 5
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" ${HEALTH_CHECK_URL} || echo "fail")

              if [ "$HTTP_CODE" == "200" ]; then
                echo "âœ… í—¬ìŠ¤ ì²´í¬ ì„±ê³µ!"
                IS_HEALTHY=1
                break
              else
                echo "â³ ì‹œì‘ ëŒ€ê¸° ì¤‘... ($i/10) (Code: $HTTP_CODE)"
              fi
            done

            # 5. ê²°ê³¼ ì²˜ë¦¬ ë° íŠ¸ë˜í”½ ì „í™˜
            if [ "$IS_HEALTHY" -eq 1 ]; then
              echo "ğŸ”„ Caddy ì—°ê²° ë³€ê²½ ì¤‘ (Port: $TARGET_PORT)..."
              echo "reverse_proxy localhost:${TARGET_PORT}" | sudo tee ${UPSTREAM_CONF} > /dev/null

              if sudo caddy reload --config /etc/caddy/Caddyfile; then
                echo "ğŸ‰ ë°°í¬ ì„±ê³µ ë° íŠ¸ë˜í”½ ì „í™˜ ì™„ë£Œ."

                # 6. êµ¬ë²„ì „ ì¢…ë£Œ
                echo "ğŸ›‘ êµ¬ë²„ì „ í”„ë¡œì„¸ìŠ¤ ì‚­ì œ (Port: $CURRENT_PORT)..."
                pm2 delete "daeng-backend-${CURRENT_PORT}" || true
                pm2 save
              else
                echo "ğŸš¨ Caddy Reload ì‹¤íŒ¨! ë¡¤ë°±í•©ë‹ˆë‹¤."
                # pm2 delete "daeng-backend-${TARGET_PORT}" || true
                # exit 1
              fi
            else
              echo "âŒ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨. ë°°í¬ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
              # pm2 delete "daeng-backend-${TARGET_PORT}" || true
              # exit 1
              echo "âš ï¸ ë””ë²„ê¹… ëª¨ë“œ: PM2 í”„ë¡œì„¸ìŠ¤ ìœ ì§€"
            fi

            # ì˜¤ë˜ëœ ë¦´ë¦¬ì¦ˆ í´ë” ì •ë¦¬
            echo "ğŸ§¹ ì˜¤ë˜ëœ ë¦´ë¦¬ì¦ˆ ì •ë¦¬ ì¤‘..."
            cd ${RELEASES_DIR} && ls -t | tail -n +6 | xargs -I {} rm -rf {} || true