name: BE CI

on:
  pull_request:
    branches: ["main", "dev"]
  push:
    branches: ["main", "dev"]
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: be-ci-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  RELEASE_ID: ${{ github.sha }}

jobs:
  ci:
    name: CI
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Record CI start
        id: ci_time
        run: echo "start=$(date +%s)" >> "$GITHUB_OUTPUT"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"
          cache: "gradle"

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Test & Check
        id: time_check
        run: |
          start=$(date +%s)
          ./gradlew clean check -x test --no-daemon
          end=$(date +%s)
          echo "start=${start}" >> "$GITHUB_OUTPUT"
          echo "end=${end}" >> "$GITHUB_OUTPUT"

      - name: Build (bootJar)
        id: time_build
        run: |
          start=$(date +%s)
          ./gradlew bootJar -x test --no-daemon
          end=$(date +%s)
          echo "start=${start}" >> "$GITHUB_OUTPUT"
          echo "end=${end}" >> "$GITHUB_OUTPUT"

      - name: List artifacts
        run: ls -al build/libs

      - name: Upload build artifact (jar)
        uses: actions/upload-artifact@v4
        with:
          name: daeng-map-api-${{ env.RELEASE_ID }}
          path: build/libs/*.jar
          if-no-files-found: error
          retention-days: 30

      - name: Record CI end
        id: ci_time_end
        if: always()
        run: echo "end=$(date +%s)" >> "$GITHUB_OUTPUT"

      - name: Calculate CI times
        id: ci_calc
        if: always()
        env:
          COMMIT_MSG: ${{ github.event.pull_request.title || github.event.head_commit.message || github.workflow }}
        run: |
          ci_total=$(( ${{ steps.ci_time_end.outputs.end }} - ${{ steps.ci_time.outputs.start }} ))
          check_sec=$(( ${{ steps.time_check.outputs.end || 0 }} - ${{ steps.time_check.outputs.start || 0 }} ))
          build_sec=$(( ${{ steps.time_build.outputs.end || 0 }} - ${{ steps.time_build.outputs.start || 0 }} ))
          echo "ci_total=${ci_total}" >> "$GITHUB_OUTPUT"
          echo "check_sec=${check_sec}" >> "$GITHUB_OUTPUT"
          echo "build_sec=${build_sec}" >> "$GITHUB_OUTPUT"
          # 커밋 메시지에서 줄바꿈을 공백으로 변환하고, 쌍따옴표 이스케이프
          safe_msg=$(echo "$COMMIT_MSG" | tr '\n' ' ' | sed 's/"/\\"/g' | head -c 200)
          echo "safe_msg=${safe_msg}" >> "$GITHUB_OUTPUT"

      - name: Notify Discord (CI Success)
        if: success()
        uses: Ilshidur/action-discord@0.4.0
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          DISCORD_EMBEDS: |
            [{
              "title": "[BE] CI: success",
              "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "color": 5763719,
              "description": "${{ steps.ci_calc.outputs.safe_msg }}",
              "fields": [
                {"name": "Release ID", "value": "`${{ env.RELEASE_ID }}`", "inline": true},
                {"name": "Actor", "value": "${{ github.actor }}", "inline": true},
                {"name": "Branch", "value": "${{ github.ref_name }}", "inline": true},
                {"name": "Total CI", "value": "${{ steps.ci_calc.outputs.ci_total }}s", "inline": true},
                {"name": "Check", "value": "${{ steps.ci_calc.outputs.check_sec }}s", "inline": true},
                {"name": "Build", "value": "${{ steps.ci_calc.outputs.build_sec }}s", "inline": true}
              ],
              "timestamp": "${{ github.event.head_commit.timestamp || github.event.pull_request.updated_at }}"
            }]

      - name: Notify Discord (CI Failure)
        if: failure()
        uses: Ilshidur/action-discord@0.4.0
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          DISCORD_EMBEDS: |
            [{
              "title": "[BE] CI: failure",
              "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "color": 15548997,
              "description": "${{ steps.ci_calc.outputs.safe_msg }}",
              "fields": [
                {"name": "Release ID", "value": "`${{ env.RELEASE_ID }}`", "inline": true},
                {"name": "Actor", "value": "${{ github.actor }}", "inline": true},
                {"name": "Branch", "value": "${{ github.ref_name }}", "inline": true},
                {"name": "Total CI", "value": "${{ steps.ci_calc.outputs.ci_total }}s", "inline": true},
                {"name": "Check", "value": "${{ steps.ci_calc.outputs.check_sec }}s", "inline": true},
                {"name": "Build", "value": "${{ steps.ci_calc.outputs.build_sec }}s", "inline": true}
              ],
              "timestamp": "${{ github.event.head_commit.timestamp || github.event.pull_request.updated_at }}"
            }]
